<div class="container mb-5">
  <div class="card post-form-card shadow-lg border-0 overflow-hidden">
    <div class="card-body p-5">
      <!-- Title -->
      <h5 class="card-title mb-4 fw-bold text-dark">
        <i class="bi bi-file-earmark-text-fill me-3 text-primary"></i>
        Write a New Blog Post
      </h5>

      <form #post="ngForm" (ngSubmit)="submit(post)">
        <div class="mb-4">
          <input
            type="text"
            class="form-control form-control-lg title-input"
            name="title"
            placeholder="Enter your blog title..."
            required
            minlength="5"
            ngModel
          />
          <div class="form-text text-muted mt-2">
            <i class="bi bi-info-circle me-1"></i>
            Minimum 5 characters
          </div>
        </div>
        <div class="mb-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <label class="form-label fw-semibold">Content (Markdown)</label>
            <button
              type="button"
              class="btn btn-sm btn-outline-secondary"
              (click)="togglePreview()"
            >
              <i class="bi" [class.bi-eye]="!showPreview" [class.bi-eye-slash]="showPreview"></i>
              {{ showPreview ? 'Edit' : 'Preview' }}
            </button>
          </div>

          @if (!showPreview) {
          <textarea
            class="form-control content-textarea markdown-editor"
            name="content"
            rows="12"
            [(ngModel)]="content"
            placeholder="# Your blog post starts here...\n\nUse **Markdown** for formatting.\n\n```js\n// Code blocks are supported\n ('Hello');\n```"
            required
            minlength="10"
          ></textarea>
          <div class="form-text text-muted mt-2">
            <i class="bi bi-markdown-fill me-1"></i>
            <a
              href="https://www.markdownguide.org/cheat-sheet"
              target="_blank"
              class="text-decoration-none"
            >
              Full Markdown support
            </a>
          </div>
          } @else {
          <article class="markdown-body p-4 border rounded-3 bg-light">
            <markdown [data]="content"></markdown>
          </article>
          }
        </div>
        <div class="mb-4">
          <input
            type="file"
            class="d-none"
            id="fileInput"
            accept="image/*,video/*"
            multiple
            (change)="onFileChange($event)"
            #fileInput
          />

          @if (files.length === 0) {
          <div
            class="file-upload-area p-5 text-center border-2 border-dashed rounded-3 cursor-pointer"
            (click)="fileInput.click()"
            (dragover)="onDragOver($event)"
            (drop)="onDrop($event)"
            [class.dragover]="dragOver"
          >
            <i class="bi bi-images display-4 text-primary mb-3"></i>
            <p class="fw-semibold mb-1">Add images & videos</p>
            <p class="text-muted small mb-0">
              Drag & drop or click â€¢ Supports JPG, PNG, GIF, MP4, WebM
            </p>
          </div>
          } @if (files.length > 0) {
          <div class="preview-grid">
            @for (file of files; track file.id) {
            <div class="preview-item position-relative rounded-3 overflow-hidden bg-dark shadow-sm">
              <button
                type="button"
                class="btn btn-danger btn-sm rounded-circle position-absolute top-0 end-0 m-2 z-3"
                (click)="removeFile(file.id)"
              >
                <i class="bi bi-x-lg"></i>
              </button>

              @if (file.isImage) {
              <img [src]="file.preview" class="preview-media w-100 h-100 object-fit-cover" />
              } @else {
              <video
                [src]="file.preview"
                class="preview-media w-100 h-100 object-fit-cover"
                controls
              ></video>
              <div
                class="position-absolute bottom-0 start-0 m-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded small"
              >
                <i class="bi bi-play-fill"></i>
              </div>
              }

              <div class="p-2 bg-white">
                <small class="d-block text-truncate text-muted">{{ file.name }}</small>
                <small class="text-muted">{{ formatFileSize(file.size) }}</small>
              </div>
            </div>
            }
          </div>

          <button
            type="button"
            class="btn btn-outline-primary w-100 mt-3 d-flex align-items-center justify-content-center gap-2"
            (click)="fileInput.click()"
          >
            <i class="bi bi-plus-circle"></i>
            Add More Media
          </button>
          }
        </div>

        <!-- Submit -->
        <button
          type="submit"
          class="btn btn-success btn-lg w-100 submit-btn fw-semibold d-flex align-items-center justify-content-center gap-2"
          [disabled]="!post.valid || isSubmitting"
        >
          @if (isSubmitting) {
          <span class="spinner-border spinner-border-sm" role="status"></span>
          } @else {
          <i class="bi bi-send-fill"></i>
          }
          <span>Publish Blog Post</span>
        </button>

        <!-- Error -->
        @if (error) {
        <div
          class="alert alert-danger d-flex align-items-center mt-3 py-3 px-4 rounded-3"
          role="alert"
        >
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <div><strong>Error:</strong> {{ error }}</div>
        </div>
        }
      </form>
    </div>
  </div>
</div>
